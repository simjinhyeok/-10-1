\chapter{オーロラの3次元計測と可視化}
\label{chap:Measurement}
\minitoc

\thispagestyle{empty}

\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{はじめに}
\label{sec:}

本章では，3章で平行化し歪みを除去した画像対を入力としてオーロラの3次元形状を計測し可視化する手法について述べる．

まず\ref{sec:tejunn}節では，本章で提案する3次元計測手法の全体の流れについて述べる．

次に\ref{sec:GeomagMatchingMethod}節では，地磁気情報を利用したオーロラ画像対からの密な対応点検出手法について述べる．

そして\ref{sec:Multicamera}節では，3視点以上の複数視点画像を用いることで対応点検出の精度を向上させる手法について述べる．

\ref{sec:3dimensional}節では，\ref{sec:GeomagMatchingMethod}節と\ref{sec:Multicamera}節によって取得した対応点の
3次元座標を算出する手法について述べる．

最後に\ref{sec:3dvisualization}節で，取得した対応点群とその3次元座標を用いてオーロラの3次元形状を可視化する手法について述べる．

\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{オーロラの3次元計測の手順}
\label{sec:tejunn}

本節では，提案手法におけるオーロラの3次元計測の流れについて述べる．
本研究では基本的に三角測量の原理に基づいてオーロラの3次元計測を行う．
2枚1対のオーロラ画像対のオーロラ領域から密に対応点を検出し，三角測量の原理により対応点の高度を算出することで
オーロラの3次元形状を計測する．具体的な処理の流れを図\ref{fig:4Flow}に示す．\\


まず3章の手法によって平行化された2枚1対のオーロラ画像を入力とする．
これらの画像は同時刻に撮影されたものを用いる．
次に入力平行化画像対のオーロラ領域から対応点を検出する．
このとき2章で述べた通り，画像情報に加え地磁気情報を利用する．
これによって画像中のオーロラ領域から密に対応点を検出する．\\

続いて，対応点算出用の平行化画像対とは別視点から撮影された画像を利用し，
画像対から検出された対応点の正誤を判定する．
対応付けが誤っていた場合，対応点を除去，またはより信頼性の高い対応点へと対応付けし直す．
これによって対応点検出の精度を向上させる．\\

次に，検出された対応点の高度を視差から三角測量の原理によって高度を算出し，3次元計測結果として出力する．
また，検出された全対応点の3次元座標を用いて形状の可視化処理を行うことでオーロラの3次元形状を出力する．
次節からそれぞれ詳細に説明する．

\begin{figure}[b]
    \begin{center}
        \includegraphics[width=8cm]{./chap4/eps/4Flow.eps}
%\vspace{-7mm}
        \caption{提案手法による3次元計測の流れ}
        \label{fig:4Flow}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}

\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{地磁気情報を利用した対応点検出手法}
\label{sec:GeomagMatchingMethod}
オーロラは半透明で特徴的なテクスチャの少ない対象であるため，
画像情報のみからではオーロラ画像対における対応点を正確かつ密に検出することは困難である．
そこで提案手法では，対応点検出の際に画像情報に加え，オーロラ形状を決定する大きな要因の1つである地磁気の情報を利用する．


\subsection{地磁気線とエピポーラ線による対応点決定}
\subsubsection{地磁気線と対応点の関係}
\label{subsubsec:geomag_corres}
オーロラは太陽風中に含まれるプラズマ粒子が地球に降り注ぎ地球大気と衝突し発光することで発生する．
つまりオーロラは光の集合体であるため厚みを持っているが，一般的にその厚みはオーロラのスケールに対して非常に薄くカーテン形状と例えられるほどである．
図\ref{fig:AuroraThick}にオーロラの高度と厚さの関係を示す．
オーロラの発生する高度は非常に高く，下端では上空約100 km，上端では上空約300〜500 kmと言われている\cite{jones1971}．
さらにオーロラの発生する長さは数千 kmとも言われている．しかし一方でオーロラの厚さは約200 m程度である\cite{赤祖父2009}．
そのため地上からオーロラを観測した場合，オーロラはほぼ厚みのないシート形状の表面で発光する粒子の集合とみなせる．
従って対応点はシート形状の表面から検出される．\\

\begin{figure}[b]
 \begin{minipage}{0.5\hsize}
  \begin{center}
   \includegraphics[width=5cm]{./chap4/eps/AuroraThick.eps}
  \end{center}
  \caption{オーロラの高度と厚さの関係}
  \label{fig:AuroraThick}
 \end{minipage}
 \begin{minipage}{0.5\hsize}
  \begin{center}
   \includegraphics[width=5cm]{./chap4/eps/Geomag_CorrespondingPoint.eps}
  \end{center}
  \caption{地磁気とオーロラの対応点の関係}
  \label{fig:Geomag_CorrespondingPoint}
 \end{minipage}
\end{figure}

オーロラを形成するプラズマ粒子は地磁気に沿って地球に降り注ぐことから，発光粒子は図\ref{fig:Geomag_CorrespondingPoint}のように地磁気線上に存在する．
図\ref{fig:Geomag_CorrespondingPoint}中の円は発光粒子を表している．
図\ref{fig:Geomag_CorrespondingPoint}中においてカメラAとカメラBでオーロラを撮影した場合，
両画像上の赤色の円は赤線で表した地磁気線上にある．つまり対応点は画像間で対応する地磁気線上に存在する．\\

オーロラの形状や模様は地磁気線を反映しているため，画像上で地磁気線の存在を確認することができる．実際のオーロラ画像を図\ref{fig:Geomag_CorrespondingPoint}に示す．
図\ref{fig:Geomag_CorrespondingPoint}の中央から図下部に向かって放射状に直線のような模様が確認できる．
直線のような模様は地磁気線を意味している．
以上のことからオーロラの画像情報を用いて画像間で対応する地磁気線を同定し，対応点検出に利用する．








\begin{figure}[t]
\begin{center}
\includegraphics[width=8cm]{./chap4/eps/GeomagLineEvi.eps}
\caption{オーロラ画像に見る地磁気線}
\label{fig:mag_geomagline_aurora}
\end{center}
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{エピポーラ線と対応点の関係}
\label{subsubsec:epipolar}
\ref{subsubsec:geomag_corres}にてオーロラ画像間における対応点が地磁気線と関連付けられることを述べたが，
ステレオ画像において対応点はエピポーラ幾何と呼ばれる幾何拘束によって関連付けられることが知られている．
図\ref{fig:epipolar}にステレオ画像とエピポーラ拘束の関係について示す．
2つのカメラで3次元空間中の同一な点を見ている場合，両カメラのレンズ中心と対象物は一つの平面上に存在する．この平面をエピポーラ平面という．
エピポーラ平面とそれぞれの画像平面とは2点で交わり，1点が対象物を投影した点でありこの点が対応点となる．
そしてもう1点がエピポールと呼ばれる点である．
エピポーラ平面と画像平面との交線はエピポーラ線と呼ばれ，一方の画像の投影点に対応する他方の画像上の点は必ずこのエピポーラ線上に存在する．
つまりステレオ画像において一方の画像に対応する他方の画像上の点を探索する場合，エピポーラ線上のみを探索するのみでよい．
さらに，図\ref{fig:epipolar_parallel}に示すように画像対が平行化されている場合，画像平面上にエピホールは存在せずエピポーラ線は
画像横軸に平行となる．従って平行化画像対において対応点は必ず同$v$座標上に存在する．
提案手法においてもこの制約を用いる．


\begin{figure}[tbp]
 \begin{minipage}{0.5\hsize}
  \begin{center}
   \includegraphics[width=6.5cm]{./chap4/eps/epipolar.eps}
  \end{center}
  \caption{エピポーラ線と対応点の関係}
  \label{fig:epipolar}
 \end{minipage}
 \begin{minipage}{0.5\hsize}
  \begin{center}
   \includegraphics[width=6cm]{./chap4/eps/epipolar_parallel.eps}
  \end{center}
  \caption{平行化画像対におけるエピポーラ線}
  \label{fig:epipolar_parallel}
 \end{minipage}
\end{figure}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\subsubsection{対応点決定}
\ref{subsubsec:geomag_corres}と\ref{subsubsec:epipolar}にて述べたように，
オーロラ画像間の対応点は画像間で対応する地磁気線上に存在し，かつエピポーラ線上に存在する．
従って画像間で対応する地磁気線が同定されている場合，
図\ref{fig:Geomagnetism_epipolar}に示すように対応点は地磁気線とエピポーラ線との交点を意味する．
なお，本手法では画像対は平行ステレオ画像となっているため，
エピポーラ線は全て画像の$u$軸に平行である．
よってオーロラ領域において，対応する地磁気線上の$v$座標の等しい点同士は全て対応点となる．
これによって
テクスチャ変化の極めて小さいオーロラ領域上であっても
対応点を密に検出することが可能となる．
画像間で同一な地磁気線を対応付ける手法に関しては\ref{subsec:GeomagMatching}にて説明する．


\begin{figure}[b]
    \begin{center}
        \includegraphics[width=90mm]{./chap4/eps/Geomagnetism_epipolar_revise.eps}
%\vspace{-7mm}
        \caption{対応点決定手法}
        \label{fig:Geomagnetism_epipolar}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{地磁気線の対応付け}
\label{subsec:GeomagMatching}

\ref{subsubsec:geomag_corres}にて，画像情報を用いて地磁気線を対応付けると述べたが，
正確な対応付けのために地磁気の物理情報も加えて利用する．
地磁気は通常，緯度や経度，高度によってその方向や傾きが変化する．
これらの値を地磁気の分布を全地球的スケールで数式によって表現したモデルである，
国際標準地球磁場（International geomagnetic reference field: the 12th generation）モデル（以下，IGRF-12）\cite{thebault2015}によって取得する．
IGRF-12によってカメラ設置場所の緯度・経度から地磁気の偏角$D$ [rad]と伏角$I$ [rad]を算出する．
偏角と伏角を図\ref{fig:mag_vec}にて説明する．
地磁気の方向ベクトルを水平面に投影した方向を磁北という．
偏角は磁北と北方向とがなす角度を指し，北方向から東方向に向かう方向を正とする．
伏角は地磁気の方向ベクトルと磁北方向とがなす角度を指し，水平面から下向きに向かう角度を正とする．
以下，IGRF-12モデルにて算出した偏角$D$と伏角$I$を用いて説明する．

%\vspace{1cm}
\begin{figure}[b]
\begin{center}
\includegraphics[width=8cm]{./chap4/eps/Geomagnetism_vector.eps}
\caption{地磁気の方向ベクトルと偏角・伏角との関係}
\label{fig:mag_vec}
\end{center}
\end{figure}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{画像中における地磁気線}
\begin{figure}[b]
	\begin{center}
       % \vspace{-0.5cm}
        \def\subfigcapskip{-0.2cm}
        \subfigure[画像撮像範囲における地磁気の傾き]{
        	\includegraphics[width=4cm]{./chap4/eps/Geomag_parallel.eps}
		\label{fig:camera_aurora}}
    		\hspace{1cm}
	\subfigure[画像上に投影した地磁気線]{
	        \includegraphics[width=5cm]{./chap4/eps/VanishingPointDraw.eps}
		\label{fig:image_geomag}}
    		%\hspace{-1cm}
                %\vspace{-0.3cm}
                \caption{オーロラ画像と地磁気線の関係}
		\label{fig:aurora_image_geomag}
        \end{center}
\end{figure}

\begin{figure}[t]
\begin{center}
\includegraphics[width=8cm]{./chap4/eps/VanishingPointEvi.eps}
\caption{消失点へ集まる地磁気線}
\label{fig:VanishingPointEvi}
\end{center}
\end{figure}

カメラの緯度・経度情報とIGRF-12に基づいて計算した地磁気の偏角$D$と伏角$I$から，地磁気を画像上に投影することが可能である．
%この投影した地磁気の線を地磁気線と呼ぶこととする．
オーロラ上の地磁気と，オーロラ画像上に投影した地磁気線を図\ref{fig:aurora_image_geomag}に示す．
前述したように地磁気は緯度・経度によって変化するが，図\ref{fig:camera_aurora}に示すようにカメラの撮像範囲では
地磁気の変化は極めて小さく地磁気はほぼ平行とみなせる．
地磁気が平行であるとき，画像上に投影される全ての地磁気線は図\ref{fig:image_geomag}のように消失点で交わる．
実際のオーロラ画像を図\ref{fig:VanishingPointEvi}に示す．これはオーロラを形成する地磁気線の下付近から撮影した画像であるため画像中央付近に向かって放射状に直線が集まっていることが確認できる．\\

IGRF-12によって取得した偏角$D$と伏角$I$を用いて，ENZe座標系における地磁気の方向ベクトル$(E_{mag}, N_{mag}, Ze_{mag})^T$を式(\ref{eq:ENZemag})にて算出できる．
また，式(\ref{eq:ENZemag})によって算出した$(E_{mag}, N_{mag}, Ze_{mag})^T$を用いて，リクティファイド座標系における地磁気線の単位ベクトル$({n}_{1}, {n}_{2}, {n}_{3})^T$は式(\ref{eq:n1n2n3})によって算出される．


\begin{equation}
\begin{bmatrix}
E_{mag}\\
N_{mag} \\
Ze_{mag}
\end{bmatrix}
=
\begin{bmatrix}
\cos{I}\sin{D} \\
\cos{I}\cos{D} \\
-\sin{I}
\end{bmatrix} .
\label{eq:ENZemag}
\end{equation}


\begin{equation}
\begin{bmatrix}
n_1\\
n_2 \\
n_3
\end{bmatrix}
=\mathbf{R}(N, -\beta)\mathbf{R}(D, \alpha)
\begin{bmatrix}
E_{mag} \\
N_{mag} \\
Ze_{mag}
\end{bmatrix} .
\label{eq:n1n2n3}
\end{equation}

画像上で地磁気線が交わる消失点の座標$({u}_{v}, {v}_{v})$は，カメラの焦点距離$f$と式(\ref{eq:n1n2n3})から以下の式(\ref{eq:UvVv})で表すことができる．

\begin{equation}
\begin{bmatrix}
u_v\\
v_v
\end{bmatrix}
=
\begin{bmatrix}
C_u + f{n_1}/{n_3} \\
C_v + f{n_2}/{n_3}
\end{bmatrix} .
\label{eq:UvVv}
\end{equation}

消失点座標を算出することで，画像中でオーロラが存在するテクスチャ上のピクセルから
地磁気線が算出可能となる．

\subsubsection{ブロックマッチングによる対応付け}
\label{subsubsec:blockmatching}
画像間で対応する地磁気線を検出するために，地磁気線周辺の領域同士の類似性を評価する．
地磁気線を対応付ける具体的な手法を図\ref{fig:GeomagnetismLineDetection}に示す．
初めに全体の流れについて述べる．
まずカメラA画像上の地磁気線周辺の領域を切り抜きテンプレートとする．
次にカメラB画像上から，ある地磁気線周辺の領域を切り抜き評価領域とする．
カメラB画像上から抽出する評価領域を変更しながら逐一テンプレートと評価領域のテクスチャの類似度を計算し，
最も類似度の高い地磁気線同士を対応する地磁気線とする．
また，地磁気線の誤対応を減少させるために物理的に解明された知見を用いて，評価領域の抽出範囲を制限する．
オーロラは発光の集合体であるが，地上から観測した場合，その発光は下端部のやや上部で最も強度が大きいことが知られている\cite{jones1971}．
以降，オーロラ上の最も強度の大きい発光部をオーロラの最輝部と呼ぶ．
この最輝部の存在高度はオーロラの種類によって異なるが，それぞれの種類においての存在高度の範囲は物理的な知見として得られている\cite{jones1971}．
そこで本研究では最輝部の高度情報を評価領域の抽出範囲の制限に利用する．\\
%ブロックマッチングの際に

\begin{figure}[tb]
    \begin{center}
        \includegraphics[width=100mm]{./chap4/eps/Geomag_matching_way.eps}
%\vspace{-7mm}
        \caption{地磁気線の対応付け手法}
        \label{fig:GeomagnetismLineDetection}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}





%画像間で対応する地磁気線を，ブロックマッチングによる類似度の評価によって検出する．


続いて，テンプレートの抽出法についての詳細を説明する．
カメラA画像において消失点を通り$u$軸に平行な線と地磁気線とがなす角を$\theta_L$とする．
まず，角度$\theta_L$の地磁気線が通るオーロラの下端部・上端部・最輝部の座標を画像処理によって算出する．
下端部・上端部・最輝部の座標算出手法の詳細については\ref{subsec:joutankatan}項にて後述する．
図\ref{fig:GeomagnetismLineDetection}中，カメラA画像上の緑線がオーロラの下端，青線が上端，黄線が最輝部を表している．
角度$\theta_L$のときの下端・上端の$v$座標をそれぞれ$v_{lower}(\theta_{\rm L})$，$v_{lupper}(\theta_{\rm R})$とし，
またこのときの最輝部の座標を$(u_t, v_t)$とする．
地磁気線の周辺領域を，地磁気線を中心として横幅左右$w/2$ [pixel]ずつオーロラの下端から上端まで切り抜き，これを角度$\theta_L$の地磁気線に対するテンプレートとする．
また$(u_t, v_t)$をテンプレートに対する代表点と呼ぶこととする．\\

次に評価領域の抽出法と，その抽出範囲について説明する．
まず評価領域の代表点$(u_r, v_r)$を定める．評価領域の代表点の$v$座標はエピポーラ拘束からテンプレートの代表点の$v$座標と等しい．
また$u_r$を選ぶ範囲を${u_{\mathrm{min}} \leq u_r \leq u_{\mathrm{max}}}$とする．
この範囲のことを探索範囲と呼ぶこととし，探索範囲は最輝部の存在高度により算出する．
探索範囲の算出手法については\ref{subsubsec:range}目にて詳細に述べる．
$(u_r, v_r)$と地磁気の消失点とを結ぶ直線が評価する地磁気線となる．この地磁気線と$u$軸に平行な線と地磁気線とがなす角を$\theta_R$とする．
そしてテンプレートの抽出同様，角度$\theta_R$の地磁気線を中心として横幅左右$w/2$ [pixel]ずつオーロラの下端から上端まで切り抜き，これを評価領域とする．\\

テンプレートと評価領域のテクスチャの類似度を評価する際には，比較する画素について注意が必要である．
たとえ正しく対応付いた地磁気線周辺同士を切り抜いていたとしても，テンプレート中のテクスチャと評価領域中のテクスチャは互いに射影変換の関係にあるからである．
この問題について図\ref{fig:ProjectiveTransform}に示す．
図\ref{fig:camera_geomag}中においてカメラAとカメラBは平行化されたステレオカメラペアを示し，赤矢印と青矢印はZ軸方向にのびた互いに平行な直線であるとする．
このときカメラAとカメラBによって取得される画像において，赤線に注目し先述の手法によりテンプレートと評価領域を抽出した結果を図\ref{fig:aurora_geomag}に示す．
平行な2直線がテンプレート，評価領域と交わる点を図\ref{fig:aurora_geomag}のとおり点A〜点D，点A'〜点D'とする．
このとき四角形ABCDと四角形A'B'C'D'は互いに射影変形の関係にある．従ってテンプレートと評価領域の横幅は$w$で等しい一方で，
線分ADと線分A'D'の長さは異なっており，同様に線分BCと線分B'C'の長さも異なる．
以上のことから，テンプレートと評価領域の類似度を評価する際には，射影変形の影響を考慮して比較する画素を選択する必要がある．
しかし画像サイズに比べて$w$の値が十分小さい場合においては，線分ADと線分A'D'，また線分BCと線分B'C'は等しいと考えることができ，
テンプレートと評価領域はせん断のみのアフィン変形の関係であると近似できる．
よって本手法では，せん断の変形のみを考慮しテンプレートと評価領域から比較する画素を選択し類似度を評価する．\\


\begin{figure}[tb]
	\begin{center}
        %\vspace{-0.5cm}
        \def\subfigcapskip{-0.2cm}
        \subfigure[2本の平行線画像を取得する平行ステレオカメラ]{
        	\includegraphics[clip,width=0.5\columnwidth]{./chap4/eps/Geomag_katamuki.eps}
		\label{fig:camera_geomag}}
    		%\vspace{-0.5cm}
	\subfigure[テンプレートと評価領域における2本の平行線]{
	        \includegraphics[clip,width=0.7\columnwidth]{./chap4/eps/syaeihenkan.eps}
		\label{fig:aurora_geomag}}
    		%\hspace{-1cm}
                %\vspace{-0.3cm}
                \caption{テンプレートと評価領域の射影変換の関係}
		\label{fig:ProjectiveTransform}
        \end{center}
\end{figure}



\begin{figure}[tb]
    \begin{center}
        \includegraphics[width=100mm]{./chap4/eps/GeomagLineMatching.eps}
%\vspace{-7mm}
        \caption{地磁気線上の注目点と座標}
        \label{fig:GeomagnetismLine_theta}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}

次にテンプレートと評価領域の類似度の評価方法について述べる．
テンプレートと評価領域の類似度は，正規化相互相関（Zero-mean Normalized Cross-Correlation: ZNCC）によって評価する．
以降の説明で出てくる変数と座標について図\ref{fig:GeomagnetismLine_theta}に示す．
テンプレート内の中心を通る地磁気線上の任意の画素座標を以下の式(\ref{eq:ijrange})--式(\ref{eq:ujtheta})を用いて$(u(j,\theta_L), v(j))$と表す．
\begin{gather}
%-\frac{w}{2} \leq i \leq \frac{w}{2},& \qquad 0 \leq j \leq v_{lower}(\theta_L) - v_{upper}(\theta_L)
 0 \leq j \leq v_{lower}(\theta_L) - v_{upper}(\theta_L)
\label{eq:ijrange}\\
v(j) = v_{upper}(\theta_L) + j \\
u(j, \theta) = u_v + (v(j) -v_v)\tan\theta
\label{eq:ujtheta}
\end{gather}

$(u(j,\theta_L), v(j))$に対応する評価領域中の点の座標は同様に$(u(j,\theta_R), v(j))$と表せる．
$\theta_R$は以下の式(\ref{eq:theta_u})，式(\ref{eq:theta_r})によって表され，
${u_{\mathrm{min}} \leq u_r \leq u_{\mathrm{max}}}$であることから
$\theta_R$の範囲は式(\ref{eq:thetamaxmin})を用いて${\theta_{\mathrm{min}} \leq \theta_R \leq \theta_{\mathrm{max}}}$
と表される．

\begin{gather}
\theta(u) = \tan^{-1}(\frac{v_t -v_v}{u-u_v}) .
\label{eq:theta_u}\\
\theta_R = \theta(u_r) .
\label{eq:theta_r}
\end{gather}

\begin{equation}
\begin{split}
\theta_{min} &= \min \{\theta(u_{min}), \theta(u_{max})\} \\
\theta_{max} &= \max \{\theta(u_{min}), \theta(u_{max})\}
\end{split}
\label{eq:thetamaxmin}
\end{equation}

カメラA画像中における座標$(u,v)$の輝度値を$T(u,v)$とし，カメラB画像中における座標$(u,v)$の輝度値を$I(u,v)$とすると，
テンプレートと評価領域中の任意のピクセルの輝度値をそれぞれ以下の式(\ref{eq:irange})--式(\ref{eq:Tij})から$T'(u,v)$，$I'(u,v)$と表せる．

\begin{gather}
-\frac{w}{2} \leq i \leq \frac{w}{2}
\label{eq:irange}\\
T'(i,j) = T(u(j, \theta_L)+i, v(j))
\label{eq:Tij}\\
I'(i,j) = I(u(j, \theta_R)+i, v(j))
\label{eq:Iij}
\end{gather}

以上の式を用いて，カメラA画像中の角度$\theta_L$の地磁気線周辺の領域と，カメラB画像中の角度$\theta_R$の地磁気線周辺の領域の類似度$R_{\theta_L\theta_R}$は，
アフィン変形を考慮して以下の式(\ref{eq:jrange})，式(\ref{eq:zncc})によって計算される．

\begin{gather}
v_{range} = v_{lower}(\theta_L) - v_{upper}(\theta_L) 
\label{eq:jrange}\\
R_{\theta_L\theta_R} = 
\frac{{\displaystyle \sum_{j=0}^{v_{range}}}{\displaystyle \sum_{i=-\frac{w}{2}}^{\frac{w}{2}}}(I'(i,j)-\overline{I})(T'(i,j)-\overline{T})}{\sqrt{{\displaystyle \sum_{j=0}^{v_{range}}}{\displaystyle \sum_{i=-\frac{w}{2}}^{\frac{w}{2}}}(I'(i,j)-\overline{I})^2\times{\displaystyle \sum_{j=0}^{v_{range}}}{\displaystyle \sum_{i=-\frac{w}{2}}^{\frac{w}{2}}}(T'(i,j)-\overline{T})^2}}
\label{eq:zncc}
\end{gather}

式(\ref{eq:zncc})によって計算された$R_{\theta_L\theta_R}$は-1から1までの値をとり，値が大きいほど類似度が高いことを意味する．
式(\ref{eq:thetamaxmin})にて求めた範囲${\theta_{\mathrm{min}} \leq \theta_R \leq \theta_{\mathrm{max}}}$間で
$\theta_R$を変化させ，類似度$R_{\theta_L\theta_R}$が最大となるときテンプレートと評価領域は最も類似した領域同士であるといえる．
よってこのとき角度$\theta_L$の地磁気線と，式(\ref{eq:Req})から求められる角度$\theta_{corr}$の地磁気線は対応しているとする．

\begin{equation}
\theta_{corr}= \argmax_{\theta_{\mathrm{min}} \leq \theta_R \leq \theta_{\mathrm{max}}} R_{\theta_L\theta_R} .
\label{eq:Req}
\end{equation}


ただし，類似度$R_{\theta_L\theta_R}$が閾値以下の場合，信頼できる地磁気線対応結果はないとする．
なお閾値は経験的に定めた．



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%






%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\subsubsection{複数のブロックサイズの利用}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{探索範囲の限定}
\label{subsubsec:range}
%\clearpage
オーロラ画像は類似したテクスチャが非常に多いため，探索範囲を制限せずに対応する地磁気線を検出した場合，
誤対応する可能性が増加する．
そこで，3次元空間におけるオーロラ最輝部の存在高度に関する物理的知見を用いて探索範囲を制限する．
%
%オーロラの下端の高度は大気に流入するプラズマ粒子のエネルギーに依存しており，
%さらにそのプラズマ粒子のエネルギーはオーロラの色や種類を決定付ける要因でもある．
解明されている物理的知見から，オーロラの種類や色によってオーロラの最輝部高度の範囲を制限することが可能である．\\

物理的知見を基に，画像上のオーロラの種類や色から最輝部の存在高度$h$を${h_{\mathrm{min}} \leq h \leq h_{\mathrm{max}}}$としたとき，
左画像中のテンプレートの座標$(u_L, v_L)$，カメラ間の距離$d$を用いて以下の式(\ref{eq:XYZh})--式(\ref{eq:eq2})から探索範囲が限定される．

\begin{equation}
\begin{bmatrix}
X\\
Y \\
Z(h)
\end{bmatrix}
=\mathbf{R}(N, -\beta)
\begin{bmatrix}
0 \\
0 \\
h
\end{bmatrix}\\
\label{eq:XYZh}
\end{equation}

\begin{equation}
Z(h) = h\cos{\beta}
\label{eq:Zh}
\end{equation}


\begin{eqnarray}
	u_L - f\frac{d}{Z(h_{\mathrm{min}})} \leq u_{\mathrm R} \leq u_L - f\frac{d}{Z(h_{\mathrm{max}})} .
\label{eq:eq2}
\end{eqnarray}

\clearpage
\subsection{画像中におけるオーロラの上端・下端・最輝部の検出}
\label{subsec:joutankatan}

\begin{figure}[bp]
 \begin{minipage}{0.5\hsize}
  \begin{center}
   \includegraphics[height=6cm]{./chap4/eps/scanning.eps}
  \end{center}
  \caption{上端・下端・最輝部の探索手法}
  \label{fig:scanning}
 \end{minipage}
 \begin{minipage}{0.5\hsize}
  \begin{center}
   \includegraphics[height=6cm]{./chap4/eps/UpperLowerStar.eps}
  \end{center}
  \caption{オーロラ画像中の上端・下端・星部}
  \label{fig:UpperLowerStar}
 \end{minipage}
\end{figure}

\ref{subsubsec:blockmatching}目にて述べたとおり，
提案手法の地磁気線対応付けアルゴリズムではカメラA画像において角度$\theta_{\rm L}$の地磁気線につき1点ずつ上端部・下端部・最輝部の座標が必要となる．
そこで本項では角度$\theta_{\rm L}$の地磁気線上からオーロラの上端・下端・最輝部を検出する手法について説明する．\\

オーロラの上端・下端・最輝部それぞれの探索手法のコンセプトを図\ref{fig:scanning}に示す．
本手法では消失点を原点として，消失点から離れる方向を探索方向と呼ぶ．
地磁気線が通るピクセルの輝度値を消失点から探索方向に向かって順に取得し，輝度値の変化から上端・下端・最輝部を判別する．
消失点の定義から，地磁気線は消失点に近いほど高度が高い．
そのため消失点から探索方向に向かって必ず上端・最輝部・下端の順に検出される．
なお本手法における輝度値は，オーロラ画像をグレースケール画像へと変換した画像より取得する．\\

上端・下端・最輝部それぞれの判断は，オーロラ画像における上端・下端・最輝部の特徴に基づいて行う．
まず最輝部の検出手法について説明する．
\ref{subsubsec:blockmatching}目で定義したとおり，最輝部とは輝度値の最も大きいピクセルを指す．
よって地磁気線上で最も輝度値の大きいピクセルを最輝部とする．\\

次に上端の検出手法について説明する．
上端と下端の判断の基準となる画像的特徴を図\ref{fig:UpperLowerStar}に示す．
図\ref{fig:UpperLowerStar}から確認できるように，上端の境界は非常に不明瞭である．
その理由はオーロラの発生原理にある．
前述のようにオーロラの発生要因であるプラズマ粒子は，地球に降り込み次々に大気と衝突し発光させる．
しかし地球大気は高度が高いほど密度が低下し，また発光によってオーロラを形成する発光原子の割合も低下する．
そのため高度が高くなるほど発光確率は低下し，発光強度が徐々に低下する．以上のことから上端には明確な境界が存在しない．
そこで本研究においては，閾値処理によって上端を検出する．%$\Theta_{\rm up}$
消失点から探索方向に向かって輝度値を調査したとき，初めて最輝部の輝度値の一定割合以上となる点を上端と定義する．
なお上端の定義に用いる割合は試行錯誤的に決定した．\\


最後に下端の検出手法について説明する．
図\ref{fig:UpperLowerStar}から確認できるように，オーロラの下端部は一般的に境界がはっきりしているという特徴をもつ．
この特徴も上端同様にオーロラの発生原理に由来する．
%前述のようにオーロラの発生要因であるプラズマ粒子は，大気に降り込み次々に大気と衝突し発光させる．
地球に降り込むプラズマ粒子は大気と衝突する度にエネルギを失い，エネルギを使い切ったとき大気との衝突は終了する．
従って1つのプラズマ粒子が大気を発光させる高度の下限はプラズマ粒子のエネルギに依存する．
オーロラ発生時には同時に大量のプラズマ粒子が降り込んでいるが，同時に振り込むプラズマ粒子の持つエネルギは非常に近いく，それぞれの粒子が発光を終える高度も近い．
以上の性質からオーロラの下端部では境界が比較的明瞭となる．
つまり地磁気線上の輝度値を探索方向に向かって調査していくと，急激に輝度値の下がる箇所が下端であるといえる．
そこで地磁気上の輝度値を探索方向に関して微分したとき，最小負値をとる点を下端と判断する．\\

以上の判断基準に則って上端・下端を検出する際には，画像中の星や障害物に注意する必要がある．
図\ref{fig:UpperLowerStar}から確認できるように，星は周囲のオーロラ領域よりも明るく写り，また障害物は暗く写る．
そのため地磁気線が画像中の星や障害物の上を通過している場合，それらの点では輝度値の変化が極めて高いことが考えられる．
そのような点が存在する場合，上記の判断基準によって正常な探索を行うことは困難である．
よって画像中の星や障害物の影響を除外する必要がある．
%画像中に障害物や星がある場合，輝度値の変化が極めて大きい．
そこで輝度値を探索方向に関して微分したとき微分値の絶対値が閾値より大きい場合，星または障害物と判断しそのピクセルは探索対象から除外する．
なお，この閾値も試行錯誤的に決定する．
以上で述べた，地磁気線上における探索対象とその判断基準について表\ref{table:ScanningPoints}にまとめる．\\


提案手法による上端・下端・最輝部検出の例を図\ref{fig:ScanningLine}に示す．
図\ref{fig:Input019L}が入力画像，
図\ref{fig:GrayLinePoint}が入力画像をグレースケール変換した画像を表している．
また図\ref{fig:GrayLinePoint}中には地磁気線と，提案手法により検出した上端・下端・最輝部を記入してある．
図\ref{fig:GrayLinePoint}中の地磁気線にそって輝度値を取得した結果が図\ref{fig:ValueGray}である．
このとき地磁気線は星上を通過しており，輝度値が周囲に比べ急激に上昇している箇所があることが確認できる．
図\ref{fig:ValueGray}を移動平均によって平滑化した結果が図\ref{fig:ValueGraySmooth}であり，
図\ref{fig:ValueGraySmooth}を微分した結果が図\ref{fig:ValueGrayDiff}である．
図\ref{fig:ValueGray}中から輝度値の最大地点を求めることで最輝部を求めた．
また図\ref{fig:ValueGraySmooth}から閾値処理によって上端を求め，
図\ref{fig:ValueGrayDiff}中の最小負値となる点から下端を求めた．
求めた上端・下端・最輝部を図\ref{fig:ValueGray}と図\ref{fig:ValueGraySmooth}にプロットしている．
星部では輝度値が上端の輝度値よりも高く，微分値が下端よりも低いにもかかわらず，その影響を除外し上端・下端が検出されていることが確認できる．
また，画像全体から上端・下端・最輝部を検出した結果を図\ref{fig:ScannningResult}に示す．
図\ref{fig:ScannningResult}中青点が上端を，白点が下端を，黄点が最輝部を表している．
画像全体からそれぞれの点が検出されていることが確認できる．

\begin{table}[htb]
\begin{center}
\caption{地磁気線上から探索する点とその判断基準}
\label{table:ScanningPoints}
\begin{tabular}{l c}\hline
探索対象 & 判断基準\\ \hline \hline
上端 & 輝度値が初めて最輝部の輝度値の一定割合以上となる\\ 
下端 & 輝度値の微分値が最小負値 \\
最輝部 & 輝度値が最大 \\
星・障害物 & 微分値の絶対値が閾値以上 \\ \hline
\end{tabular}
\end{center}
\end{table}

\textcolor{red}{式形式で書いた方が良い？}

\begin{figure}[tb]
	\begin{center}
        %\vspace{-0.5cm}
        \def\subfigcapskip{-0.2cm}
        \subfigure[入力オーロラ画像]{
        	\includegraphics[clip,width=0.45\columnwidth]{./chap4/eps/Input019L.eps}
		\label{fig:Input019L}}
    		%\vspace{-0.5cm}
	\subfigure[グレースケール画像における走査線上の上端・下端・最輝部の探索結果]{
	        \includegraphics[clip,width=0.45\columnwidth]{./chap4/eps/GrayLinePoint.eps}
		\label{fig:GrayLinePoint}}\\
       \subfigure[走査線上の輝度値]{
        	\includegraphics[clip,width=0.9\columnwidth]{./chap4/eps/ValueGray.eps}
		\label{fig:ValueGray}}
       \subfigure[走査線上の輝度値に対する移動平均結果]{
        	\includegraphics[clip,width=0.9\columnwidth]{./chap4/eps/ValueGraySmooth.eps}
		\label{fig:ValueGraySmooth}}
    		%\vspace{-0.5cm}
	\subfigure[走査線上の輝度値の移動平均グラフに対する微分結果]{
	        \includegraphics[clip,width=0.9\columnwidth]{./chap4/eps/ValueGrayDiff.eps}
		\label{fig:ValueGrayDiff}}\\
%\subfigure[2本の平行線画像を取得する平行ステレオカメラ]{
  %      	\includegraphics[clip,width=0.5\columnwidth]{./chap4/eps/UpperLowerBrightPoint.eps}
	%	\label{fig:camera_geomag}}
    		%\hspace{-1cm}
                %\vspace{-0.3cm}
                \caption{走査線上の上端部・下端部・最輝部の探索}
		\label{fig:ScanningLine}
        \end{center}
\end{figure}


\begin{figure}[tb]
    \begin{center}
        \includegraphics[clip,width=0.7\columnwidth]{./chap4/eps/UpperLowerBrightPoint2.eps}
%\vspace{-7mm}
        \caption{上端部・下端部・最輝部の検出結果}
        \label{fig:ScannningResult}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}

%\subsubsection{上端の検出}
%\subsubsection{下端の検出}
%\subsubsection{最輝点の検出}

\clearpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{複数視点画像を利用した対応点検出精度向上}
\label{sec:Multicamera}

\ref{sec:GeomagMatchingMethod}節にて，1対の平行ステレオ画像から地磁気線を対応付け，対応点を検出する手法について説明した．
本手法では三角測量の原理から対応点の3次元座標を求めることでオーロラ形状の3次元計測を行う．
そのため，\ref{sec:GeomagMatchingMethod}節の手法によって最低2視点のオーロラ画像から3次元形状を計測することが可能である．
しかし2章にて述べたようにオーロラ画像中にはテクスチャ変化の非常に緩やかな領域が存在し，そのような領域においては誤った地磁気線の対応付けが行われる可能性がある．
地磁気線の誤対応が生じる様子を図\ref{fig:Cam2MissCorresponding}に示す．
対応する地磁気線の探索において本来異なる地磁気線同士を評価していたとしても，
地磁気線周辺の領域が極めて類似している場合には同一の地磁気線であると判断される．
そして2視点画像のみからはこの判断の正誤を判別することは不可能である．
そこで本節では，計測用画像対とは別視点の画像を使用することで地磁気の対応付けの正誤を判別し，計測精度を向上させる手法を提案する．\\



\begin{figure}[b]
	\begin{center}
        %\vspace{-0.5cm}
        \def\subfigcapskip{-0.2cm}
        \subfigure[地磁気線誤対応の原因]{
        	\includegraphics[clip,width=0.35\columnwidth]{./chap4/eps/Cam2miss.eps}
		\label{fig:MissCorrespondingReason}}
    		%\vspace{-0.5cm}
	\subfigure[画像対における誤対応地磁気線]{
	        \includegraphics[clip,width=0.45\columnwidth]{./chap4/eps/Cam2missImages.eps}
		\label{fig:Cam2missImages}}\\
                \caption{地磁気線の対応付けが誤っている場合}
		\label{fig:Cam2MissCorresponding}
        \end{center}
\end{figure}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{地磁気線対応付けの正誤判定手法のアプローチ}
\label{subsec:multi_ap}




複数視点画像を用いた地磁気線の誤対応判定手法の概念図を図\ref{fig:MultiCameraCheck}に示す．
カメラAとカメラB画像を用いて\ref{sec:GeomagMatchingMethod}節の手法により地磁気線周辺のテクスチャの類似度を評価する．
カメラA，カメラBとは別に$n_{\rm c}$台のカメラを誤対応判定用に使用する．
誤対応判定用カメラのうち$i$ $(i=1,2,...,n_{\rm c})$台目のカメラをカメラ$\rm C_{\it i}$とする．
これ以降誤対応判定用カメラを代表してカメラ$\rm C_{\it i}$と呼ぶ．
図\ref{fig:MultiCameraCheck}中において赤矢印と橙矢印をカメラA画像とカメラB画像によって比較している地磁気線とする．
赤地磁気線と橙地磁気線周辺のテクスチャが類似している場合，この2本の地磁気線は同一の地磁気線と判断される．
このとき，それぞれの地磁気線上から対応点を抽出し三角測量によって3次元座標を計算すると，対応点の3次元座標はオーロラ表面外に存在すると計算される．
この3次元座標を用いて対応点をカメラ$\rm C_{\it i}$へ投影すると，投影点は赤地磁気線とも橙地磁気線とも異なる地磁気線上に投影される．
この地磁気線は図\ref{fig:MultiCameraCheck}中では紫の地磁気線を指す．
紫地磁気線周辺のテクスチャが赤地磁気線周辺のテクスチャと異なる場合，これらは\ref{subsec:GeomagMatching}項の手法を用いて識別可能である．
カメラA画像上の地磁気線とカメラ$\rm C_{\it i}$画像上の地磁気線が異なることは，同時にカメラA画像上の地磁気線とカメラB画像上の地磁気線も異なることを意味する．
よって図\ref{fig:Multicamera_hanbetsu}に示すように，カメラA画像と誤対応判定用画像の地磁気線が1組でも異なると判断された場合，
カメラA画像とカメラB画像間の地磁気線は誤対応していると判断する．\\


カメラ$\rm C_{\it i}$画像を用いた地磁気線の対応付けの正誤判定の様子を図\ref{fig:Multicamera_algo}に示す．
まず手法を説明する上で用いる記号の定義から説明する．
カメラAとカメラBを平行化した画像をそれぞれ$I_{\rm A}$，$I_{\rm B}$，
カメラAとカメラ$\rm C_{\it i}$を平行化した画像をそれぞれ$I^{(i)}_{\rm A}$，$I^{(i)}_{\rm C}$と呼ぶこととする．
またカメラAとカメラBを平行化するリクティファイド座標系を座標系$\Sigma_{0}$，
カメラAとカメラ$\rm C_{\it i}$を平行化するリクティファイド座標系を座標系$\Sigma_{i}$と呼ぶ．
画像$I_{\rm A}$中の地磁気線を$l_{\rm L}$，画像$I_{\rm B}$中の地磁気線を$l_{\rm R}$とし，
それぞれの地磁気線の角度を$\theta_{\rm L}$，$\theta_{\rm R}$とする．
同様に画像$I^{(i)}_{\rm A}$の地磁気線を$l^{(i)}_{\rm L}$，画像$I^{(i)}_{\rm C}$中の地磁気線を$l^{(i)}_{\rm R}$とし，
それぞれの角度を$\theta^{(i)}_{\rm L}$，$\theta^{(i)}_{\rm R}$とする．\\

本手法では入力画像を$I_{\rm A}$，$I_{\rm B}$，$I^{(i)}_{\rm A}$，$I^{(i)}_{\rm C}$とする．
図\ref{fig:Multicamera_algo}中の地磁気線$l_{\rm L}$と$l_{\rm R}$の対応付けの正誤を判定する場合について説明する．
まず画像$I_{\rm A}$上の地磁気線$l_{\rm L}$に対応する画像$I^{(i)}_{\rm A}$上の地磁気線$l^{(i)}_{\rm L}$を，
座標変換($\Sigma_{0}$→$\Sigma_{i}$)によって算出する．
次に画像$I^{(i)}_{\rm C}$上の地磁気線$l^{(i)}_{\rm R}$を，地磁気線$l_{\rm L}$と$l_{\rm R}$を用いて算出する．
最後に$l^{(i)}_{\rm L}$と$l^{(i)}_{\rm R}$の周辺領域の類似度を評価することで$l_{\rm L}$と$l_{\rm R}$の対応付けの正誤を判定する．
以上の処理の手順を図\ref{fig:Multicamera_flow}に示す．
各処理の詳細については\ref{subsection:zahyouhenkan}項--\ref{subsection:seigohandan}項にて述べる．

\begin{figure}[b]
	\begin{center}
        %\vspace{-0.5cm}
        \def\subfigcapskip{-0.2cm}
        \subfigure[誤対応判定用カメラ画像への地磁気線の投影]{
        	\includegraphics[clip,width=0.7\columnwidth]{./chap4/eps/Multicamera_ng.eps}
		\label{fig:Multicamera_ng}}
    		%\vspace{-0.5cm}
	\subfigure[カメラA画像と誤対応判定用カメラ画像の比較]{
	        \includegraphics[clip,width=0.7\columnwidth]{./chap4/eps/Multicamera_hanbetsu.eps}
		\label{fig:Multicamera_hanbetsu}}\\
                \caption{複数視点画像を用いた誤対応判定手法の概念図}
		\label{fig:MultiCameraCheck}
        \end{center}
\end{figure}

\begin{figure}[tb]
    \begin{center}
        \includegraphics[clip,width=0.65\columnwidth]{./chap4/eps/Multicamera_algo.eps}
%\vspace{-7mm}
        \caption{地磁気線の対応付けの正誤判定に用いる各画像上の地磁気線}
        \label{fig:Multicamera_algo}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}

\begin{figure}[tb]
    \begin{center}
        \includegraphics[clip,width=0.45\columnwidth]{./chap4/eps/Multicamera_flow.eps}
%\vspace{-7mm}
        \caption{地磁気線の対応付けの正誤判定に必要な処理の手順}
        \label{fig:Multicamera_flow}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}


\clearpage



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{異なるリクティファイド座標系における地磁気線の算出}
\label{subsection:zahyouhenkan}
本項では，画像$I_{\rm A}$上の地磁気線$l_{\rm L}$と一致する画像$I^{(i)}_{\rm A}$上の地磁気線を算出する手法について説明する．
地磁気線を決定するためには消失点の座標と，地磁気線上の点の座標が最低1点必要である．
そこで，画像$I_{\rm A}$上の消失点と代表点の座標から，
画像$I^{(i)}_{\rm A}$上の消失点と代表点の座標を求める．
画像$I^{(i)}_{\rm A}$上の地磁気線の算出手法のコンセプトを図\ref{fig:TransGeomag}に示す．\\

画像$I_{\rm A}$と画像$I^{(i)}_{\rm A}$は異なるリクティファイド座標系にて平行化された画像であるが，
これらの画像間の変化はカメラの回転のみである．
座標系$\Sigma_{0}$から設置されたカメラA座標系への回転行列を${\bf R}_0$，
座標系$\Sigma_{i}$から設置されたカメラA座標系への回転行列を${\bf R}_i$とすると，
これらは3.5節の手法によって取得可能である．
取得した回転行列${\bf R}_0$，${\bf R}_i$を用いて画像$I^{(i)}_{\rm A}$上における消失点と代表点の座標を算出する．\\

画像$I_{\rm A}$中の代表点の座標を$(u_{\rm t}, v_{\rm t})$，画像中心を$(C_u, C_v)$とすると，
カメラのレンズ中心と画像平面上の代表点を通る光線の単位ベクトル$(x_{\rm t}, y_{\rm t}, z_{\rm t})^{\rm T}$は
以下の式(\ref{eq:xtytzt})，式(\ref{eq:kt})にて算出される．


\begin{figure}[b]
    \begin{center}
        \includegraphics[clip,width=0.7\columnwidth]{./chap4/eps/TransGeomag.eps}
%\vspace{-7mm}
        \caption{画像$I^{(i)}_{\rm A}$上の地磁気線の算出手法のコンセプト図}
        \label{fig:TransGeomag}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}


\begin{eqnarray}
\begin{bmatrix}
x_{\rm t}\\
y_{\rm t} \\
z_{\rm t}
\end{bmatrix}
&=&k_{\rm t}
\begin{bmatrix}
u_{\rm t} -C_u\\
v_{\rm t} - C_v\\
f_{\rm p}
\end{bmatrix} ,
\label{eq:xtytzt}
\end{eqnarray}

\begin{eqnarray}
ただしk_{\rm t} &=&\frac{1}{\sqrt{(u_{\rm t} -C_u)^2 +(v_{\rm t} -C_v)^2 + f_{\rm p}^2}}.
\label{eq:kt}
\end{eqnarray}

式(\ref{eq:xtytzt})，式(\ref{eq:kt})にて算出した光線のベクトルは
式(\ref{eq:xityitzit})によって座標系$\Sigma_{i}$におけるベクトルへと変換され，
さらに式(\ref{eq:xityitzit})，式(\ref{eq:teisuuk})によって画像$I^{(i)}_{\rm A}$上の座標$(u^{(i)}_{\rm t}, v^{(i)}_{\rm t})$へと変換される．


\begin{eqnarray}
\begin{bmatrix}
x^{(i)}_{\rm t}\\
y^{(i)}_{\rm t} \\
z^{(i)}_{\rm t}
\end{bmatrix}
&=&{\bf R}^{-1}_{i}{\bf R}_{0}
\begin{bmatrix}
x_{\rm t}\\
y_{\rm t} \\
z_{\rm t}
\end{bmatrix} ,
\label{eq:xityitzit} \\
%
\begin{bmatrix}
u^{(i)}_{\rm t}\\
v^{(i)}_{\rm t} 
\end{bmatrix}
&=&k'_{\rm t}
\begin{bmatrix}
x^{(i)}_{\rm t} + C_u\\
y^{(i)}_{\rm t} +C_v
\end{bmatrix} .
%ただしk_{\rm t} &=&\frac{1}{\sqrt{(u_{\rm t} -C_u)^2 +(v_{\rm t} -C_v)^2 + f_{\rm p}^2}} ,\\
%k'_{\rm t} &=& \frac{f_{\rm p}}{z^{(i)}_{\rm t}} .
\label{eq:u'tv't}
\end{eqnarray}

\begin{eqnarray}
ただしk'_{\rm t} &=& \frac{f_{\rm p}}{z^{(i)}_{\rm t}} .
\label{eq:teisuuk}
\end{eqnarray}

同様にして，画像$I^{(i)}_{\rm A}$上の消失点の座標$(u^{(i)}_{\rm v}, v^{(i)}_{\rm v})$も算出可能である．
上記のようにして算出した座標$(u^{(i)}_{\rm t}, v^{(i)}_{\rm t})$と$(u^{(i)}_{\rm v}, v^{(i)}_{\rm v})$を用いて，
4.3.2項と同様に式(\ref{eq:theta(i)_u})，式(\ref{eq:theta(i)_L})から画像$I^{(i)}_{\rm A}$上の地磁気線の角度$\theta^{(i)}_{\rm L}$を算出する．

\begin{gather}
\theta^{(i)}(u) = \tan^{-1}(\frac{v^{(i)}_{\rm t} -v^{(i)}_{\rm v}}{u-u^{(i)}_{\rm v}}) ,
\label{eq:theta(i)_u}\\
\theta^{(i)}_{\rm L}  = \theta^{(i)}(u^{(i)}_{\rm t}).
\label{eq:theta(i)_L}
\end{gather}

上記の手法により，画像$I_{\rm A}$上の地磁気線$l_{\rm L}$と一致する画像$I^{(i)}_{\rm A}$上の地磁気線が算出される．
次項では
画像$I^{(i)}_{\rm C}$上の地磁気線$l^{(i)}_{\rm R}$を，地磁気線$l_{\rm L}$と$l_{\rm R}$を用いて算出する手法について説明する．

\clearpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{ステレオ画像の遷移による誤対応判定画像上における地磁気線算出}
\label{subsection:stereosenni}

画像$I^{(i)}_{\rm C}$上の地磁気線$l^{(i)}_{\rm R}$を，地磁気線$l_{\rm L}$と$l_{\rm R}$を用いて算出する．
\ref{subsection:zahyouhenkan}項で述べた通り，地磁気線の算出のためには消失点の座標と地磁気線上の点の座標が必要である．
画像$I^{(i)}_{\rm A}$と画像$I^{(i)}_{\rm C}$は平行化された画像であるため，
画像$I^{(i)}_{\rm C}$上の消失点座標は\ref{subsection:zahyouhenkan}項で算出した画像$I^{(i)}_{\rm A}$上の消失点座標と等しい．
そのため，地磁気線$l^{(i)}_{\rm R}$上の点の座標を1点算出することで地磁気線を決定することができる．\\


本手法では，ステレオ画像の遷移によって画像$I^{(i)}_{\rm C}$の地磁気線$l^{(i)}_{\rm R}$上の点の座標を取得する．
ステレオ画像の遷移による対応点算出手法の概要を図\ref{fig:Fmatrix}に示す．
4.3.1項で述べたように，画像対において一方の画像上のある点に対応する他方の画像上の点は必ずエピポーラ線上に存在する．
従って地磁気線$l_{\rm L}$と$l_{\rm R}$上の代表点に対応する画像$I^{(i)}_{\rm C}$上の代表点は
2本のエピポーラ線の交点となる．\\

\begin{figure}[b]
    \begin{center}
        \includegraphics[clip,width=0.6\columnwidth]{./chap4/eps/Fmatrix.eps}
%\vspace{-7mm}
        \caption{ステレオ遷移による対応点算出手法}
        \label{fig:Fmatrix}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}

\begin{figure}[b]
    \begin{center}
        \includegraphics[clip,width=0.6\columnwidth]{./chap4/eps/Fequation.eps}
%\vspace{-7mm}
        \caption{ステレオ画像における基礎行列とエピポーラ線の関係}
        \label{fig:Fequation}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}

画像間におけるエピポーラ線の導出には基礎行列と呼ばれる行列が用いられる．
ステレオ画像間における基礎行列とエピポーラ線の関係を図\ref{fig:Fequation}に示す．
図\ref{fig:Fequation}中において，カメラ1画像中の点の座標を同時座標系を用いて${\bf p}_1 = (u_1, v_1,1)$と表し，
カメラ2画像上の点を同様に${\bf p}_2 = (u_2, v_2,1)$と表す．
このとき${\bf p}_1$に対応するカメラ2画像上のエピポーラ線は基礎行列$\bf F$を用いて式(\ref{eq:Fmatrix_ippan})によって算出される．

%エピポーラ線の式
\begin{eqnarray}
{\bf p}^{\rm T}_1{\bf F}{\bf p}_2=0 .
\label{eq:Fmatrix_ippan}
\end{eqnarray}

カメラの内部パラメータと外部パラメータが既知であるとき基礎行列$\bf F$を解析的に算出することが可能である．
カメラの内部パラメータ行列$\bf K$は一般的に焦点距離$f$ [mm]，画像の$u$軸方向の画素サイズ$s_x$ [mm]，$v$軸方向の画素サイズ$s_y$ [mm]，
画像中心の座標$(C_u, C_v)$を用いて式(\ref{eq:naibu_K})--式(\ref{eq:naibupara})のように定義される．

\begin{eqnarray}
{\bf K}&=&
\begin{pmatrix}
f_x &0 &C_u\\
0 &f_y &C_v\\
0 &0 &1
\end{pmatrix} ,
\label{eq:naibu_K}\\
ただしf_x &=& \frac{f}{s_x},\\
f_y &=& \frac{f}{s_y}.
\label{eq:naibupara}
\end{eqnarray}

カメラ1とカメラ2の内部パラメータ行列をそれぞれ${\bf K}_1$，${\bf K}_2$とする．
また，外部パラメータとしてカメラ間の回転と平行移動を用いる．図\ref{fig:Fequation}中において，カメラ1座標系から世界座標系への回転行列と平行移動ベクトルをそれぞれ${\bf R}_1$，${\bf t}_1$と表す．
同様にカメラ2座標系から世界座標系への回転行列と平行移動ベクトルをそれぞれ${\bf R}_2$，${\bf t}_2$とし，
カメラ1座標系からカメラ2座標系への回転行列と平行移動ベクトルをそれぞれ${\bf R}_{12}$，${\bf t}_{12}$とする．
このとき，カメラ1画像からカメラ2画像への基礎行列$\bf F$は以下の式(\ref{eq:F_sansyutu})--式(\ref{eq:T12})によって算出される．


%基礎行列算出の式
\begin{eqnarray}
{\bf F} &=& ({\bf K}_1^{-1})^{\rm T}{\bf T}_{12}{\bf R}_{12}{\bf K}^{-1}_2 ,
\label{eq:F_sansyutu}\\
{\bf R}_{12} &=& {\bf R}_{1}{\bf R}^{-1}_{2} ,\\
{\bf t}_{12} &=& {\bf t}_1 - {\bf R}_1{\bf R}_2^{-1}{\bf t}_2\\
&=&
\begin{bmatrix}
t_1\\
t_2\\
t_3
\end{bmatrix}^{\rm T}  ,\label{eq:t1t2t3}\\
%
{\bf T}_{12}&=&
\begin{pmatrix}
0 &-t_3 &t_2\\
t_2 &0 &-t_1\\
-t_2 &t_1 &0
\end{pmatrix} .
\label{eq:T12}
\end{eqnarray}

式(\ref{eq:F_sansyutu})--式(\ref{eq:T12})と同様にして
画像$I_{\rm L}$$I^{(i)}_{\rm C}$間の基礎行列${\bf F}^{(i)}_{\rm A}$と，画像$I_{\rm R}$$I^{(i)}_{\rm C}$間の基礎行列${\bf F}^{(i)}_{\rm B}$を算出する．
カメラA，カメラB，カメラ${\rm C}_i$の内部パラメータ行列をそれぞれ${\bf K}_{\rm A}$，${\bf K}_{\rm B}$，${\bf K}^{(i)}_{\rm C}$とする．
3章の手法によって求めたそれぞれのカメラの画像中心と焦点距離$f_{\rm p}$ [pixel]を用いて以下の式(\ref{eq:Kabc})からそれぞれの内部パラメータ行列を決定する．


%内部パラ
\begin{eqnarray}
{\bf K}&=&
\begin{pmatrix}
f_{\rm p} &0 &C_u\\
0 &f_{\rm p} &C_v\\
0 &0 &1
\end{pmatrix} .
\label{eq:Kabc}
\end{eqnarray}


カメラAからカメラ${\rm C}_i$への回転行列と平行移動ベクトルをそれぞれ${\bf R}^{(i)}_{\rm AC}$，${\bf t}^{(i)}_{\rm AC}$とし，
同様にカメラBからカメラ${\rm C}_i$への回転行列と平行移動ベクトルをそれぞれ${\bf R}^{(i)}_{\rm BC}$，${\bf t}^{(i)}_{\rm BC}$とする．
このとき回転行列${\bf R}^{(i)}_{\rm AC}$と${\bf R}^{(i)}_{\rm BC}$は，
座標系$\Sigma_{0}$からカメラA座標系への回転行列を${\bf R}_0$と
座標系$\Sigma_{i}$からカメラA座標系への回転行列を${\bf R}_i$を用いて以下の式(\ref{eq:Rac})から求められる．

\begin{equation}
{\bf R}_{\rm{AC}}^{(i)} = {\bf R}_{\rm{BC}}^{(i)} = ({\bf R}^{-1}_{i}{\bf R}_{0})^{\rm T} .
\label{eq:Rac}
\end{equation}

また，カメラAとカメラB間の距離を$d$，カメラAとカメラ${\rm C}_i$間の距離を$d_i$とすると，
平行移動ベクトル${\bf t}^{(i)}_{\rm AC}$と${\bf t}^{(i)}_{\rm BC}$は以下の式(\ref{eq:tac})，式(\ref{eq:tbc})によって求められる．

\begin{eqnarray}
{\bf t}^{(i)}_{\rm AC} &=& ({\bf R}^{-1}_{i}{\bf R}_{0})^{\rm T}
\begin{bmatrix}
d_i\\
0\\
0
\end{bmatrix} ,\label{eq:tac}\\
%
{\bf t}^{(i)}_{\rm BC} &=& ({\bf R}^{-1}_{i}{\bf R}_{0})^{\rm T}
\begin{bmatrix}
d_i\\
0\\
0
\end{bmatrix}+
\begin{bmatrix}
-d\\
0\\
0
\end{bmatrix} .
\label{eq:tbc}
\end{eqnarray}

平行移動ベクトル${\bf t}^{(i)}_{\rm AC}$と${\bf t}^{(i)}_{\rm BC}$を用いて式(\ref{eq:t1t2t3})，式(\ref{eq:T12})と同様に
行列${\bf T}^{(i)}_{\rm AC}$，${\bf T}^{(i)}_{\rm BC}$を定義すると，
基礎行列${\bf F}^{(i)}_{\rm A}$，${\bf F}^{(i)}_{\rm B}$は以下の式(\ref{eq:Fa})，式(\ref{eq:Fb})によって算出される．

%手法のカメラ間で使用する基礎行列算出方法
\begin{eqnarray}
{\bf F}^{(i)}_{\rm A} &=& ({\bf K}_{\rm A}^{-1})^{\rm T}{\bf T}_{\rm{AC}}^{(i)}{\bf R}_{\rm{AC}}^{(i)}({\bf K}^{(i)}_{\rm C})^{-1} ,\label{eq:Fa}\\
{\bf F}^{(i)}_{\rm B} &=& ({\bf K}_{\rm B}^{-1})^{\rm T}{\bf T}_{\rm{BC}}^{(i)}{\bf R}_{\rm{BC}}^{(i)}({\bf K}^{(i)}_{\rm C})^{-1} .\label{eq:Fb}
\end{eqnarray}

以上の方法で取得した基礎行列${\bf F}^{(i)}_{\rm A}$，${\bf F}^{(i)}_{\rm B}$を用いて
画像$I^{(i)}_{\rm C}$上の地磁気線$l^{(i)}_{\rm R}$を同定する．
地磁気線$l_{\rm L}$と$l_{\rm R}$上の代表点をそれぞれ$(u_{\rm t}, v_{\rm t})$，$(u_{\rm r}, v_{\rm r})$とする．
%このとき，4.3.2項で定義したように2つの代表点の$v$座標は等しい．
また，$(u_{\rm t}, v_{\rm t})$，$(u_{\rm r}, v_{\rm r})$に対応する地磁気線$l^{(i)}_{\rm R}$上の代表点を$(u^{(i)}_{\rm r}, v^{(i)}_{\rm r})$とする．
代表点の座標を用いて，${\bf p}_{\rm t} = (u_{\rm t} \ v_{\rm t} \ 1)^{\rm T}$，${\bf p}_{\rm r} = (u_{\rm r} \ v_{\rm r} \ 1)^{\rm T}$，${\bf p}^{(i)}_{\rm r} = (u^{(i)}_{\rm r} \ v^{(i)}_{\rm r} \ 1)^{\rm T}$とすると，
%画像$I_{\rm L}$$I^{(i)}_{\rm C}$間の基礎行列を${\bf F}^{(i)}_{\rm A}$，画像$I_{\rm R}$$I^{(i)}_{\rm C}$間の基礎行列を${\bf F}^{(i)}_{\rm B}$とすると，
${\bf p}_{\rm t}$，${\bf p}_{\rm r}$に対応する画像$I^{(i)}_{\rm C}$上のエピポーラ線はそれぞれ以下の式(\ref{eq:epipolara})，式(\ref{eq:epipolarb})によって表される．


%ステレオ遷移によって対応点計算する式
\begin{eqnarray}
{\bf p}^{\rm T}_{\rm t}{\bf F}^{(i)}_{\rm A}{\bf p}^{(i)}_{\rm r}=0 ,\label{eq:epipolara}\\
{\bf p}^{\rm T}_{\rm r}{\bf F}^{(i)}_{\rm B}{\bf p}^{(i)}_{\rm r}=0 .
\label{eq:epipolarb}
\end{eqnarray}

前述した通り，$(u^{(i)}_{\rm r}, v^{(i)}_{\rm r})$は式(\ref{eq:epipolara})，式(\ref{eq:epipolarb})によって表されるエピポーラ線の交点である．
よって，$(u^{(i)}_{\rm r}, v^{(i)}_{\rm r})$は以下の式(\ref{eq:ptFa})--式(\ref{eq:uivi})から算出される．


\begin{eqnarray}
{\bf p}^{\rm T}_{\rm t}{\bf F}^{(i)}_{\rm A}&=&
\begin{bmatrix}
a^{(i)}_{\rm t} \\
b^{(i)}_{\rm t}\\
c^{(i)}_{\rm t}
\end{bmatrix}^{\rm T}  ,\label{eq:ptFa}\\
%
{\bf p}^{\rm T}_{\rm r}{\bf F}^{(i)}_{\rm B}&=&
\begin{bmatrix}
a^{(i)}_{\rm r} \\
b^{(i)}_{\rm r}\\
c^{(i)}_{\rm r}
\end{bmatrix}^{\rm T}  ,\label{eq:prFb}
\end{eqnarray}

\begin{eqnarray}
u^{(i)}_{\rm r} &=& \cfrac{b^{(i)}_{\rm t}c^{(i)}_{\rm r}-c^{(i)}_{\rm t}b^{(i)}_{\rm r}}{a^{(i)}_{\rm t}b^{(i)}_{\rm r}-a^{(i)}_{\rm r}b^{(i)}_{\rm t}} ,\\
v^{(i)}_{\rm r} &=& \cfrac{-a^{(i)}_{\rm t}c^{(i)}_{\rm r}+c^{(i)}_{\rm t}a^{(i)}_{\rm r}}{a^{(i)}_{\rm t}b^{(i)}_{\rm r}-a^{(i)}_{\rm r}b^{(i)}_{\rm t}}.
\label{eq:uivi}
\end{eqnarray}

なお，式(\ref{eq:ptFa})を計算すると$a^{(i)}_{\rm t}$の値は0となる．
そのため式(\ref{eq:epipolara})で表されるエピポーラ線は画像$u$軸に平行となる．
これは\ref{subsection:zahyouhenkan}項にて求めた，
画像$I^{(i)}_{\rm A}$上の点$(u^{(i)}_{\rm t}, v^{(i)}_{\rm t})$のエピポーラ線と一致する．
よって$v^{(i)}_{\rm r}$の値は$v^{(i)}_{\rm t}$と等しい．
従って画像$I^{(i)}_{\rm C}$上の地磁気線$l^{(i)}_{\rm R}$の角度$\theta^{(i)}_{\rm R}$は，
式(\ref{eq:theta(i)_u})を用いて以下の式(\ref{eq:theta(i)_R})によって算出される．

\begin{gather}
\theta^{(i)}_{\rm R}  = \theta^{(i)}(u^{(i)}_{\rm r}).
\label{eq:theta(i)_R}
\end{gather}


以上により，画像$I^{(i)}_{\rm C}$上の地磁気線$l^{(i)}_{\rm R}$を，地磁気線$l_{\rm L}$と$l_{\rm R}$を用いて算出することができる．
次項では，\ref{subsection:zahyouhenkan}項にて求めた$\theta^{(i)}_{\rm L}$と，本項で求めた$\theta^{(i)}_{\rm R}$
を用いて地磁気線の対応付けの正誤を判定し精度を向上させる手法について述べる．

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{地磁気線の対応付けの正誤判断と精度の向上}
\label{subsection:seigohandan}

\ref{subsec:multi_ap}項で述べたように，
$\Sigma_i$座標系にて平行化された画像対$I^{(i)}_{\rm A}$，$I^{(i)}_{\rm C}$間において
角度$\theta^{(i)}_{\rm L}$の地磁気線と角度$\theta^{(i)}_{\rm R}$の地磁気線周辺の類似度$R_{\theta^{(i)}_{\rm L}\theta^{(i)}_{\rm L}}$が閾値$R_{\rm thresh}$よりも低い場合，
地磁気線の対応付けは誤っていると判断する．
$R_{\theta^{(i)}_{\rm L}\theta^{(i)}_{\rm L}}$の値は\ref{subsec:GeomagMatching}項と同様の方法にて算出する．
式(\ref{eq:ijrange})--式(\ref{eq:ujtheta})，式(\ref{eq:irange})--式(\ref{eq:zncc})において，$\theta_{\rm L}$に$\theta^{(i)}_{\rm L}$を，
$\theta_{\rm R}$に$\theta^{(i)}_{\rm R}$を代入することで$R_{\theta^{(i)}_{\rm L}\theta^{(i)}_{\rm L}}$が算出される．
また，テンプレートの抽出に必要な上端・下端の座標の値は，式(\ref{eq:xtytzt})--式(\ref{eq:teisuuk})と同様の座標変換により算出する．\\

また，ステレオ計測用画像対において地磁気線が正確に対応付いている場合，
\ref{subsec:GeomagMatching}項にて算出する類似度$R_{\theta_{\rm L}\theta_{\rm R}}$だけでなく，
$R_{\theta^{(i)}_{\rm L}\theta^{(i)}_{\rm L}}$も同様に大きな値となるはずである．
そこで，$R_{\theta_{\rm L}\theta_{\rm R}}$と$R_{\theta^{(i)}_{\rm L}\theta^{(i)}_{\rm L}}$の総和が大きいほど，
より信頼性の高い対応付け結果であるとする．\\

以上のことから，以下のような基準を定義し地磁気線の対応付けを行う．
\begin{enumerate}
	\renewcommand{\labelenumi}{\roman{enumi})}
	\setlength{\parskip}{0mm} % 段落間
	\setlength{\itemsep}{1mm} % 項目間
	\item $R_{\theta_{\rm L}\theta_{\rm R}} < R_{\rm thresh}$　となるとき地磁気線$l_{\rm L}$と$l_{\rm R}$は異なる．
	\item $R_{\theta^{(i)}_{\rm L}\theta^{(i)}_{\rm R}} < R_{\rm thresh}\ (i=1,2,...,n_{\rm c})$　となる$i$が存在するとき地磁気線$l_{\rm L}$と$l_{\rm R}$は異なる．
	\item i)，ii)以外の場合，$R_{\theta_{\rm L}\theta_{\rm R}}$と$R_{\theta^{(i)}_{\rm L}\theta^{(i)}_{\rm L}}$の総和が最大となるとき地磁気線$l_{\rm L}$と$l_{\rm R}$は同一の地磁気線である．
\end{enumerate}
\clearpage

上記のi)--iii)に従い，角度$\theta_{\rm L}$の地磁気線に対応する地磁気線の角度$\theta_{\rm corr}$を
式(\ref{eq:eta0})--式(\ref{eq:Rmulti})によって求める．


\begin{eqnarray}
    \eta_0
  = 
\left\{
\begin{array}{ll}
      1  & (R_{\theta_{\rm L}\theta_{\rm R}} \geq R_{\rm thresh})\\
      0 & (R_{\theta_{\rm L}\theta_{\rm R}} < R_{\rm thresh})
    \end{array}
\right. \label{eq:eta0}\\
    \eta_i
  = 
\left\{
\begin{array}{ll}
      1  & (R_{\theta^{(i)}_{\rm L}\theta^{(i)}_{\rm R}} \geq R_{\rm thresh})\\
      0 & (R_{\theta^{(i)}_{\rm L}\theta^{(i)}_{\rm R}} < R_{\rm thresh})
    \end{array}
\right.
\end{eqnarray}

\begin{eqnarray}
\eta &=& \prod_{i=1}^{n_{\rm c}}\eta_0\eta_i , \\
\theta_{\rm corr} &=& \argmax_{\theta_{\mathrm{min}} \leq \theta_R \leq \theta_{\mathrm{max}}} \eta\{R_{\theta_L\theta_R} + \sum_{i=1}^{n_{\rm c}}R_{\theta^{(i)}_L\theta^{(i)}_R}\} .
\label{eq:Rmulti}
\end{eqnarray}

これによって，2視点画像からでは判断できなかった地磁気線の対応付けの誤対応を検出・除去し，
より信頼性の高い対応付けを行うことが可能となる．

\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{対応点の3次元座標算出}
\label{sec:3dimensional}

本節では，画像対から検出した対応点の画像座標から3次元座標を算出する手法について説明する．
3次元座標の算出には三角測量の原理を用いる．平行ステレオカメラ画像上の対応点と3次元座標の関係を図\ref{fig:3dimensional}に示す．
カメラA画像上の対応点座標を$(u_{\rm A}, v_{\rm A})$，カメラB画像上の対応点座標を$(u_{\rm B}, v_{\rm B})$とする．
また，各カメラの焦点距離は\ref{sec:undistortion}節にて定義した$f_{\rm p}$とし，カメラ間距離は\ref{subsec:external_parameter}項にて算出した$d$とすると，
リクティファイド座標系における対応点の3次元座標$(X,Y,Z)^{\rm T}$は以下の式(\ref{eq:3dimensinal})より算出される．


\begin{eqnarray}
\left\{
\begin{aligned}
X &= \frac{u_{\rm A}-Cu}{f_{\rm p}}Z\\
Y &= \frac{v_{\rm A}-Cv}{f_{\rm p}}Z\\
Z &= \frac{f_{\rm p}d}{u_{\rm A}-u_{\rm B}}
\end{aligned}
\right.
\label{eq:3dimensinal}
\end{eqnarray}


式(\ref{eq:3dimensinal})により算出した3次元座標$(X,Y,Z)^{\rm T}$は，
以下の式(\ref{eq:3dENU})からENU座標系における3次元座標$(X^{\rm (enu)},Y^{\rm (enu)},Z^{\rm (enu)})^{\rm T}$に変換される．

\begin{equation}
\begin{bmatrix}
X^{\rm (enu)}\\
Y^{\rm (enu)}\\
Z^{\rm (enu)}
\end{bmatrix}
=\mathrm{R}(Z, -\alpha)\mathrm{R}(Y, \beta)
\begin{bmatrix}
X\\
Y\\
Z
\end{bmatrix} .
\label{eq:3dENU}
\end{equation}

以上の式によって，カメラAが設置された地点の地表面に対する対応点の3次元座標が算出される．


\begin{figure}[tb]
    \begin{center}
        \includegraphics[width=9cm]{./chap4/eps/3dimensional.eps}
%\vspace{-7mm}
        \caption{三角測量の原理による3次元座標計算}
        \label{fig:3dimensional}
    \end{center}
    %\vspace{-2.5ex}
\end{figure}
\clearpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{3次元可視化手法}
\label{sec:3dvisualization}

本節では，取得した対応点とその3次元座標を用いてオーロラの3次元形状を可視化する手法について述べる．
本手法では，ステレオ画像上で地磁気線を対応付けることで対応点を算出している．
対応付いた地磁気線上において，オーロラの上端から下端までの全ての画素が対応点となるため非常に密な対応点が取得される．
よって，取得した全ての対応点の3次元座標を\ref{sec:3dimensional}節の手法によって算出し，
図\ref{fig:3dvisualization}のように3次元空間中に対応点群をプロットすることで大まかなオーロラの形状を表現することができる．
さらに対応点群に対してNURBS曲面をフィッティングさせることで，対応点間を補間しオーロラの3次元形状を表現する．
点群に対するNURBS曲面のフィッティング手法としてBalzerらの手法\cite{balzer2012}を用いた．
以上の方法によりオーロラの3次元形状が可視化され，オーロラの形状の詳細や時間経過による変化を任意の視点から目視によって確認可能となる．

\begin{figure}[b]
	\begin{center}
        %\vspace{-0.5cm}
        \def\subfigcapskip{-0.2cm}
        \subfigure[3次元空間中への対応点のプロット]{
        	\includegraphics[clip,width=0.4\columnwidth]{./chap4/eps/3dvisualization.eps}
		\label{fig:3dvisualization}}
    		\hspace{0.5cm}
	\subfigure[対応点群に対するNURBS曲面のフィッティング]{
	        \includegraphics[clip,width=0.4\columnwidth]{./chap4/eps/3dNURBS.eps}
		\label{fig:3dNURBS}}\\
                \caption{オーロラの3次元形状可視化手法}
		\label{fig:Visualization}
        \end{center}
\end{figure}
\clearpage


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{おわりに}

本章では，3章で平行化し歪みを除去した画像対を入力としてオーロラの3次元形状を計測し可視化する手法について述べた．

まず\ref{sec:tejunn}節では，本章で提案する3次元計測手法の全体の流れについて述べた．

次に\ref{sec:GeomagMatchingMethod}節では，地磁気情報を利用したオーロラ画像対からの密な対応点検出手法について述べた．

そして\ref{sec:Multicamera}節では，3視点以上の複数視点画像を用いることで対応点検出の精度を向上させる手法について述べた．

\ref{sec:3dimensional}節では，\ref{sec:GeomagMatchingMethod}節と\ref{sec:Multicamera}節によって取得した対応点の
3次元座標を算出する手法について述べた．

最後に\ref{sec:3dvisualization}節で，取得した対応点群とその3次元座標を用いてオーロラの3次元形状を可視化する手法について述べた．

次章では，オーロラの発生原理の基づいたオーロラシミュレーションを用いて本提案手法の有効性について評価する．
\clearpage



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% Local Variables:
%%% mode: katex
%%% TeX-master: "../thesis"
%%% End:
